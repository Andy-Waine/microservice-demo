<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sushi Ordering ‚Äì Kafka Microservices Demo</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 800px;
      margin: 2rem auto;
      line-height: 1.5;
    }
    h1, h2, h3 {
      margin-bottom: 0.3rem;
    }
    p {
      margin-top: 0.2rem;
      margin-bottom: 0.8rem;
    }
    ol {
      padding-left: 1.2rem;
    }
    label {
      display: block;
      margin-top: 0.7rem;
    }
    textarea {
      width: 100%;
      height: 130px;
      font-family: monospace;
      font-size: 0.9rem;
    }
    button {
      margin-top: 0.7rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    pre {
      background: #f4f4f4;
      padding: 0.5rem;
      border-radius: 4px;
      max-height: 260px;
      overflow: auto;
      font-size: 0.85rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.4rem 0.5rem;
      text-align: left;
      font-size: 0.9rem;
    }
    th {
      background: #fafafa;
    }
    input[type="number"] {
      width: 4rem;
    }
    .section {
      margin-top: 1.8rem;
      padding-top: 0.8rem;
      border-top: 1px solid #ddd;
    }
    .note {
      font-size: 0.85rem;
      color: #555;
    }
    .step-heading {
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Sushi Restaurant üç£ Kafka/Microservices Demo</h1>
  <p>
    This page only talks to the <strong>API Gateway</strong> over HTTP.
    Behind the scenes, the gateway publishes and consumes events on <strong>Kafka</strong>,
    and separate microservices react to those events.
  </p>

  <h2>How to use this demo</h2>
  <ol>
    <li>Choose your sushi items in the menu (this builds the JSON payload sent to the API Gateway).</li>
    <li>Click <em>Place Order</em> to send the order to the API Gateway (which publishes an <code>OrderPlaced</code> event to Kafka).</li>
    <li>Use <em>Check Status</em> to see how the order moves through the microservices via Kafka events.</li>
  </ol>

  <div class="section">
    <h2>Step 1 ‚Äì Build your sushi order (client ‚Üí API Gateway)</h2>
    <p>
      This step represents the <strong>client</strong> preparing the request body that it will send
      to the <strong>API Gateway</strong>. The menu below updates the
      <strong>Items JSON</strong> field automatically; that JSON is exactly what is sent in the HTTP POST.
    </p>

    <h3>Sushi menu</h3>
    <p class="note">
      Change the quantity for any item. The <strong>Items JSON</strong> field below will update to match.
    </p>
    <table>
      <thead>
        <tr>
          <th>Item</th>
          <th>Product ID</th>
          <th>Price (USD)</th>
          <th>Quantity</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>California Roll</td>
          <td><code>CALIFORNIA-ROLL</code></td>
          <td>$7.99</td>
          <td><input type="number" min="0" value="2" class="qty-input" data-product-id="CALIFORNIA-ROLL"></td>
        </tr>
        <tr>
          <td>Spicy Tuna Roll</td>
          <td><code>SPICY-TUNA-ROLL</code></td>
          <td>$8.99</td>
          <td><input type="number" min="0" value="1" class="qty-input" data-product-id="SPICY-TUNA-ROLL"></td>
        </tr>
        <tr>
          <td>Dragon Roll</td>
          <td><code>DRAGON-ROLL</code></td>
          <td>$10.99</td>
          <td><input type="number" min="0" value="0" class="qty-input" data-product-id="DRAGON-ROLL"></td>
        </tr>
        <tr>
          <td>Miso Soup</td>
          <td><code>MISO-SOUP</code></td>
          <td>$2.49</td>
          <td><input type="number" min="0" value="1" class="qty-input" data-product-id="MISO-SOUP"></td>
        </tr>
        <tr>
          <td>Gyoza</td>
          <td><code>GYOZA</code></td>
          <td>$4.49</td>
          <td><input type="number" min="0" value="0" class="qty-input" data-product-id="GYOZA"></td>
        </tr>
        <tr>
          <td>Green Tea</td>
          <td><code>GREEN-TEA</code></td>
          <td>$1.99</td>
          <td><input type="number" min="0" value="1" class="qty-input" data-product-id="GREEN-TEA"></td>
        </tr>
      </tbody>
    </table>

    <label>
      Customer Name:
      <input id="customerName" type="text" value="Alice" />
    </label>

    <label>
      Items JSON (request body sent to the API Gateway)
      <span class="note">
        ‚Äì automatically generated from the menu above, but you can edit it if you want.
      </span>
      <textarea id="itemsJson"></textarea>
    </label>
  </div>

  <div class="section">
    <h2>Step 2 ‚Äì Place order (API Gateway ‚Üí Kafka)</h2>
    <p>
      When you click <strong>Place Order</strong>, the browser sends a POST request to
      <code>/api/orders</code> on the API Gateway. The gateway validates the request and then publishes
      an <code>OrderPlaced</code> event to <strong>Kafka</strong>. The <strong>Order Service</strong>
      (a separate microservice) subscribes to that topic and processes the order asynchronously.
    </p>

    <button id="placeOrderBtn">Place Order</button>

    <h3>Gateway response</h3>
    <p class="note">
      The API Gateway responds immediately (HTTP 202) with an <code>orderId</code>, even though
      the order is still being processed by downstream services via Kafka.
    </p>
    <pre id="placeOrderResult"></pre>
  </div>

  <div class="section">
    <h2>Step 3 ‚Äì Check order status (Kafka ‚Üí microservices ‚Üí Gateway ‚Üí client)</h2>
    <p>
      The <strong>Order Service</strong> consumes the <code>OrderPlaced</code> event, calculates the
      total, and publishes an <code>OrderConfirmed</code> event to Kafka. Both the
      <strong>Notification Service</strong> and the <strong>API Gateway</strong> listen to this event.
      The gateway updates a small in-memory store with the latest status, so the front-end can poll
      <code>/api/orders/:id</code>.
    </p>

    <label>
      Order ID:
      <input id="orderIdInput" type="text" />
    </label>
    <button id="checkStatusBtn">Check Status</button>

    <h3>Status result</h3>
    <p class="note">
      This shows whatever the API Gateway currently knows about the order
      (for example, <code>PLACED</code> or <code>CONFIRMED</code> and the computed total).
    </p>
    <pre id="statusResult"></pre>
  </div>

  <script>
    const placeOrderBtn = document.getElementById('placeOrderBtn');
    const placeOrderResult = document.getElementById('placeOrderResult');
    const statusResult = document.getElementById('statusResult');
    const orderIdInput = document.getElementById('orderIdInput');
    const itemsTextarea = document.getElementById('itemsJson');

    // Build Items JSON from the menu quantities
    function updateItemsJsonFromMenu() {
      const qtyInputs = document.querySelectorAll('.qty-input');
      const items = [];

      qtyInputs.forEach(input => {
        const qty = Number(input.value);
        const productId = input.getAttribute('data-product-id');
        if (qty > 0) {
          items.push({ productId, quantity: qty });
        }
      });

      itemsTextarea.value = JSON.stringify(items, null, 2);
    }

    // Initialize Items JSON on page load
    updateItemsJsonFromMenu();

    // Whenever quantities change, rebuild the JSON
    document.querySelectorAll('.qty-input').forEach(input => {
      input.addEventListener('input', updateItemsJsonFromMenu);
    });

    placeOrderBtn.addEventListener('click', async () => {
      placeOrderResult.textContent = 'Placing order...';
      statusResult.textContent = '';

      const customerName = document.getElementById('customerName').value;
      const itemsText = itemsTextarea.value;

      let items;
      try {
        items = JSON.parse(itemsText);
      } catch (e) {
        placeOrderResult.textContent = 'Invalid JSON in Items field';
        return;
      }

      try {
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ customerName, items })
        });

        const data = await res.json();
        placeOrderResult.textContent = JSON.stringify(data, null, 2);

        if (data.orderId) {
          orderIdInput.value = data.orderId;
        }
      } catch (e) {
        placeOrderResult.textContent = 'Error placing order: ' + e.message;
      }
    });

    document.getElementById('checkStatusBtn').addEventListener('click', async () => {
      statusResult.textContent = 'Checking status...';

      const orderId = orderIdInput.value.trim();
      if (!orderId) {
        statusResult.textContent = 'Enter an Order ID first.';
        return;
      }

      try {
        const res = await fetch('/api/orders/' + encodeURIComponent(orderId));
        const data = await res.json();
        statusResult.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        statusResult.textContent = 'Error checking status: ' + e.message;
      }
    });
  </script>
</body>
</html>
